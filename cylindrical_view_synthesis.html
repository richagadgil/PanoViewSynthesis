<!DOCTYPE html>
<html lang="en">
    <head>
        <title>cylinder map mpi example</title>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no"
        />
        <link type="text/css" rel="stylesheet" href="main.css" />
    </head>
    <body>
        <div id="container"></div>

        <script src="js/three.js"></script>
        <script type="module">
            import { VRButton } from './js/VRButton.js';

            let camera, scene, renderer, sphere, clock;

            init();

            function init() {
                const container = document.getElementById('container');

                clock = new THREE.Clock();

                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x101010);

                const light = new THREE.AmbientLight(0xffffff, 1);
                scene.add(light);

                camera = new THREE.PerspectiveCamera(
                    70,
                    window.innerWidth / window.innerHeight,
                    1,
                    2000
                );
                scene.add(camera);

                var boxWidth = 1;
                var boxHeight = 1;
                var boxDepth = 1;

                const manager = new THREE.LoadingManager();
                const loader = new THREE.TextureLoader(manager);

                var cylinders = [];
                var depths;
                var pics;

                var some_depths = [
                    100,
                    23.846155,
                    13.537119,
                    9.45122,
                    7.259953,
                    5.893536,
                    4.96,
                    4.281768,
                    3.7667074,
                    3.362256,
                    3.0362391,
                    2.7678573,
                    2.5430682,
                    2.3520486,
                    2.1877205,
                    2.0448549,
                    1.9195048,
                    1.808635,
                    1.7098732,
                    1.6213388,
                    1.5415217,
                    1.4691944,
                    1.40335,
                    1.3431542,
                    1.2879103,
                    1.2370312,
                    1.1900192,
                    1.1464497,
                    1.105958,
                    1.0682288,
                    1.032989,
                    1
                ];


                for (depths = 0; depths < 32; depths++) {
                    const panoSphereMat = new THREE.MeshBasicMaterial({
                        map: loader.load(
                            './assets/layers_1/courtyard_' +
                                depths.toString() +
                                '.png'
                        ),
                        side: THREE.BackSide,
                        transparent: true,
                        depthWrite: true,
                        blending: THREE.NormalBlending
                    });

                    const panoSphereGeo = new THREE.CylinderGeometry(
                        6 * some_depths[depths],
                        6 * some_depths[depths],
                        6 * some_depths[depths],
                        360,
                        1,
                        true
                    );

                    const cylinder = new THREE.Mesh(
                        panoSphereGeo,
                        panoSphereMat
                    );

                    cylinders.push(cylinder);
                }

                manager.onLoad = function() {
                    for (depths = 0; depths < 32; depths++) {
                        scene.add(cylinders[depths]);
                    }
                };

                renderer = new THREE.WebGLRenderer();
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.xr.enabled = true;
                renderer.xr.setReferenceSpaceType('local');
                renderer.setAnimationLoop(render);

                container.appendChild(renderer.domElement);
                document.body.appendChild(VRButton.createButton(renderer));

                window.addEventListener('resize', onWindowResize, false);
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            var time = clock.getElapsedTime();
            
            function render() {
                // If we are not presenting move the camera a little so the effect is visible

                if (renderer.xr.isPresenting === false) {
                    const new_time = clock.getElapsedTime();
                    var elapsed = new_time - time;
                    time = new_time;

                    /*camera.rotation.y += 0.001;
                    camera.position.x = Math.sin(time) * 0.05;
                    camera.position.z = Math.cos(time) * 0.05;*/

                    camera.rotation.y = elapsed/10.;
                    camera.position.x = Math.sin(elapsed) / 3;
                }

                renderer.render(scene, camera);
            }
        </script>
    </body>
</html>
